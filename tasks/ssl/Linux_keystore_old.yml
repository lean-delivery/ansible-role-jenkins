---
- name: Export certificate and private key into a bundle
  command: >-
    openssl pkcs12 -export
    -in '{{ jenkins2_home_directory }}/{{ jenkins2_local_cert_file_name }}'
    -inkey '{{ jenkins2_home_directory }}/{{ jenkins2_local_pkey_file_name }}'
    -name '{{ ansible_hostname }}'
    -passout pass:{{ jenkins2_ssl_key_store_password }}
    -out '{{ jenkins2_home_directory }}/{{ ansible_hostname }}.p12'
    -name 'default'
  args:
    chdir: '{{ jenkins2_home_directory }}/'
    creates: '{{ ansible_hostname }}.p12'
  become_flags: '-i'
  become_method: sudo

- name: Import the PKCS12 file into a new java keystore
  java_cert:
    pkcs12_path: '{{ jenkins2_home_directory }}/{{ ansible_hostname }}.p12'
    pkcs12_password: '{{ jenkins2_ssl_key_store_password }}'
    pkcs12_alias: default
    keystore_path: '{{ jenkins2_ssl_key_store }}'
    keystore_pass: '{{ jenkins2_ssl_key_store_password }}'
    keystore_create: True
    state: present
  become_flags: '-i'
  become_method: sudo
